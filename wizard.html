<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wizard: The Game of Rage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Rye&display=swap" rel="stylesheet">

    <style>
        /* --- THEME CONFIG --- */
        :root {
            --wiz-gold: #fbbf24;
            --wiz-red: #ef4444;
            --wiz-blue: #3b82f6;
            --wiz-green: #22c55e;
            --wiz-dark: #020617;
            --wiz-stone: #1e293b;
        }

        /* Base & Background - Deep Magical Void */
        body { 
            background: radial-gradient(circle at top center, #312e81 0%, #0f172a 60%, #000000 100%);
            color: #e2e8f0; 
            font-family: 'Cinzel', serif; 
            -webkit-tap-highlight-color: transparent;
        }

        /* Typography Override */
        .font-logo { font-family: 'Rye', serif; } /* Matches Box Art */
        .font-ui { font-family: 'Cinzel', serif; }

        /* The "Wizard" Logo Effect */
        .wizard-title {
            background: linear-gradient(180deg, #fcd34d 0%, #d97706 50%, #78350f 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 10px rgba(251, 191, 36, 0.3);
            letter-spacing: 0.1em;
        }

        /* Buttons - Magical Gold */
        .btn-gold {
            background: linear-gradient(135deg, #b45309 0%, #d97706 50%, #fbbf24 100%);
            border: 1px solid #78350f;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            box-shadow: 0 4px 15px rgba(217, 119, 6, 0.4);
        }
        .btn-gold:active { transform: scale(0.97); filter: brightness(0.9); }

        /* Inputs - Dark Stone */
        .input-stone {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #334155;
            color: #fbbf24;
            font-family: 'Cinzel', serif;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        .input-stone:focus {
            border-color: #fbbf24;
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.2);
        }

        /* Cards - Stone Tablets */
        .card-stone {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        /* Winner Glow */
        .winner-glow {
            border: 1px solid #fbbf24;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.2), inset 0 0 20px rgba(251, 191, 36, 0.1);
            background: linear-gradient(145deg, #1e293b, #2d2a10);
        }

        /* Utility */
        .hidden-modal { display: none !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input[type=number] { -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <header class="h-[12%] min-h-[70px] flex flex-col items-center justify-center border-b border-indigo-900/50 shadow-2xl shrink-0 z-20 bg-slate-950/50 backdrop-blur-md">
        <h1 class="font-logo text-3xl md:text-4xl wizard-title mt-2">WIZARD</h1>
        <div class="flex items-center gap-2 mb-1">
            <span id="roundBadge" class="text-[10px] text-amber-200/80 font-bold uppercase tracking-[0.2em] hidden border-t border-b border-amber-900/50 py-0.5 px-4">
                Round 1 / 20
            </span>
        </div>
    </header>

    <main class="flex-grow overflow-y-auto p-4 pb-32 no-scrollbar relative" id="mainContainer">
        <div class="fixed top-20 left-10 w-32 h-32 bg-blue-600/10 rounded-full blur-3xl pointer-events-none"></div>
        <div class="fixed bottom-20 right-10 w-40 h-40 bg-red-600/10 rounded-full blur-3xl pointer-events-none"></div>

        <div class="max-w-xl mx-auto h-full flex flex-col relative z-10">
            
            <div id="setupScreen" class="flex flex-col gap-6 pt-4 flex-grow">
                <div class="card-stone p-6 rounded-xl border-t-2 border-indigo-500">
                    <label class="block text-xs font-bold text-indigo-300 uppercase tracking-widest mb-4">Summon Players (3-6)</label>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="playerInput" onkeydown="handleEnter(event)" placeholder="Enter Name..." class="flex-grow input-stone rounded-lg px-4 py-3 font-bold outline-none text-lg placeholder-slate-600 transition-all">
                        <button onclick="addPlayer()" class="bg-indigo-900 border border-indigo-700 text-indigo-200 w-14 rounded-lg font-bold text-xl shadow-lg active:scale-95 hover:bg-indigo-800 transition-colors">+</button>
                    </div>
                    <ul id="playerList" class="space-y-2"></ul>
                </div>
                
                <div class="mt-auto mb-4 text-center">
                    <p class="text-[10px] text-slate-500 uppercase tracking-widest mb-2 font-bold">The Game of Truth & Rage</p>
                    <button onclick="startGame()" class="w-full btn-gold text-amber-950 font-black py-4 rounded-xl shadow-lg uppercase tracking-[0.2em] text-sm transition-transform active:scale-95">
                        Start Game
                    </button>
                </div>
            </div>

            <div id="gameScreen" class="hidden flex flex-col gap-4">
                
                <div id="scoreboard" class="grid grid-cols-2 sm:grid-cols-3 gap-3 pt-2"></div>

                <div id="activeBidsPanel" class="hidden bg-black/40 border border-amber-500/20 rounded-xl p-4 mt-2 backdrop-blur-sm">
                    <h3 class="text-[10px] font-bold text-amber-500 uppercase tracking-[0.2em] mb-3 text-center opacity-80">Bids</h3>
                    <div id="activeBidsGrid" class="grid grid-cols-3 gap-2 text-center"></div>
                </div>

                <div class="mt-2 pb-20">
                    <div class="flex justify-between items-end mb-3 px-1 border-b border-white/5 pb-1">
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Chronicle</h3>
                        <button onclick="resetGame()" class="text-[9px] font-bold text-red-900 bg-red-900/20 hover:bg-red-900/40 px-3 py-1 rounded uppercase transition-colors border border-red-900/30">Resign</button>
                    </div>
                    <div id="roundHistory" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </main>

    <div id="actionDock" class="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black via-black/90 to-transparent z-40 hidden">
        <div class="max-w-xl mx-auto">
            <button id="mainActionBtn" onclick="handleActionClick()" class="w-full btn-gold text-amber-950 font-black py-4 rounded-xl shadow-2xl uppercase tracking-widest text-sm flex items-center justify-center gap-3 transition-all">
                Start Game
            </button>
        </div>
    </div>

    <div id="gameModal" class="fixed inset-0 bg-black/95 backdrop-blur-md z-50 flex items-end sm:items-center justify-center hidden-modal opacity-0 transition-opacity duration-300">
        <div class="bg-slate-900 w-full max-w-md sm:rounded-2xl rounded-t-3xl shadow-2xl overflow-hidden border border-slate-700 flex flex-col max-h-[85dvh]">
            
            <div class="bg-slate-950 p-6 text-center border-b border-slate-800 shrink-0 relative overflow-hidden">
                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-32 h-1 bg-amber-500/50 blur-[5px]"></div>
                
                <h3 id="modalTitle" class="font-logo text-amber-500 text-2xl uppercase tracking-wider drop-shadow-md">Round 1</h3>
                <p id="modalSubtitle" class="text-indigo-300 text-[10px] font-bold uppercase mt-1 tracking-widest">Enter Bids</p>
            </div>

            <div id="modalContent" class="p-6 overflow-y-auto no-scrollbar space-y-4 flex-grow bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')]"></div>

            <div id="validationMsg" class="bg-red-950/80 border-t border-b border-red-900/50 text-red-200 text-[10px] font-bold py-3 text-center hidden shrink-0 uppercase tracking-wide">
                <i class="fas fa-exclamation-triangle mr-1"></i> The Bid is Forbidden!<br><span class="opacity-70 text-[9px] normal-case">(Total bids cannot equal round number)</span>
            </div>

            <div class="p-4 bg-slate-950 flex gap-3 shrink-0 border-t border-slate-800">
                <button onclick="closeModal()" class="flex-1 py-4 text-slate-500 font-bold uppercase text-[10px] hover:text-slate-300 tracking-widest">Close</button>
                <button id="modalSubmitBtn" onclick="submitModal()" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-lg uppercase text-xs shadow-lg disabled:opacity-30 disabled:cursor-not-allowed transition-all tracking-widest border border-indigo-400/30">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'wizard_v8_boxart';
        
        let state = {
            phase: 'setup', 
            players: [],
            rounds: [],
            currentRound: 1,
            maxRounds: 20, 
            currentBids: {} 
        };

        // --- INIT ---
        function init() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if(parsed && Array.isArray(parsed.players)) {
                        state = parsed;
                        if (state.phase !== 'setup') {
                            showGameScreen();
                            renderGame();
                        } else {
                            renderSetup();
                        }
                    }
                } else {
                    renderSetup();
                }
            } catch (e) {
                localStorage.removeItem(STORAGE_KEY);
                renderSetup();
            }
        }
        function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

        // --- SETUP LOGIC ---
        function handleEnter(e) { if(e.key==='Enter') addPlayer(); }
        
        function addPlayer() {
            const input = document.getElementById('playerInput');
            const name = input.value.trim();
            if(!name) return focusInput(input);
            if(state.players.length >= 6) return alert("Max 6 Wizards allowed!");
            
            state.players.push({ id: Date.now(), name, score: 0 });
            input.value = '';
            renderSetup();
            save();
            focusInput(input);
        }

        function removePlayer(idx) {
            state.players.splice(idx, 1);
            renderSetup();
            save();
        }

        function renderSetup() {
            const list = document.getElementById('playerList');
            list.innerHTML = state.players.map((p, i) => `
                <li class="flex justify-between items-center bg-slate-800/50 p-3 rounded-lg border border-slate-700/50 animate-[fadeIn_0.2s]">
                    <span class="font-bold text-indigo-100 font-ui tracking-wide">${p.name}</span>
                    <button onclick="removePlayer(${i})" class="text-slate-600 hover:text-red-400 w-8 h-8 flex items-center justify-center transition-colors text-xl">&times;</button>
                </li>
            `).join('');
        }

        function focusInput(el) { el.focus(); el.click(); }

        function startGame() {
            if(state.players.length < 3) return alert("Summon at least 3 Wizards!");
            
            state.phase = 'bidding';
            state.currentRound = 1;
            state.maxRounds = Math.floor(60 / state.players.length);
            
            state.rounds = [];
            state.currentBids = {};
            state.players.forEach(p => p.score = 0);
            
            save();
            showGameScreen();
            renderGame();
        }

        // --- GAME RENDERER ---
        function showGameScreen() {
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('actionDock').classList.remove('hidden');
            document.getElementById('roundBadge').classList.remove('hidden');
        }

        function renderGame() {
            const scoreboard = document.getElementById('scoreboard');
            const dealerIdx = (state.currentRound - 1) % state.players.length;
            const maxScore = Math.max(...state.players.map(p => p.score));

            document.getElementById('roundBadge').innerText = `Round ${state.currentRound} / ${state.maxRounds} (${state.currentRound} Cards)`;

            scoreboard.innerHTML = state.players.map((p, i) => {
                const isDealer = (i === dealerIdx);
                const isLeader = (p.score === maxScore && state.currentRound > 1);
                
                // Theme: The Dealer gets the Blue Wizard Hat
                const dealerBadge = isDealer 
                    ? `<div class="absolute -top-3 -right-2 bg-indigo-600 text-white w-8 h-8 flex items-center justify-center rounded-full border-2 border-indigo-300 shadow-[0_0_15px_rgba(79,70,229,0.6)] z-10 animate-pulse" title="Dealer"><i class="fas fa-hat-wizard text-sm"></i></div>` 
                    : '';
                
                // Theme: The Leader gets a Glowing Gold Crown
                const leaderIcon = isLeader ? `<i class="fas fa-crown text-amber-400 text-sm absolute top-3 left-3 drop-shadow-[0_0_5px_rgba(251,191,36,0.8)]"></i>` : '';
                
                return `
                <div class="card-stone p-4 rounded-xl relative flex flex-col justify-between min-h-[110px] ${isLeader ? 'winner-glow' : ''}">
                    ${dealerBadge}
                    ${leaderIcon}
                    <div class="flex items-center mb-1 ${isLeader ? 'ml-5' : ''}">
                        <span class="text-slate-300 font-bold text-xs truncate uppercase tracking-widest">${p.name}</span>
                    </div>
                    <div class="text-4xl font-logo text-white tracking-wide drop-shadow-md text-center">${p.score}</div>
                </div>`;
            }).join('');

            const btn = document.getElementById('mainActionBtn');
            const bidsPanel = document.getElementById('activeBidsPanel');
            
            if (state.phase === 'bidding') {
                btn.innerHTML = `<i class="fas fa-crystal-ball text-lg"></i> <span class="tracking-[0.15em]">Bid</span>`;
                btn.className = "w-full bg-indigo-900 border border-indigo-500 hover:bg-indigo-800 text-indigo-100 font-black py-4 rounded-xl shadow-[0_0_20px_rgba(79,70,229,0.3)] uppercase text-sm flex items-center justify-center gap-3 transition-all";
                bidsPanel.classList.add('hidden');
            } else if (state.phase === 'playing') {
                btn.innerHTML = `<i class="fas fa-scroll text-lg"></i> <span class="tracking-[0.15em]">Results</span>`;
                btn.className = "w-full btn-gold text-amber-950 font-black py-4 rounded-xl shadow-2xl uppercase text-sm flex items-center justify-center gap-3 transition-all";
                
                bidsPanel.classList.remove('hidden');
                document.getElementById('activeBidsGrid').innerHTML = state.players.map((p, i) => `
                    <div class="bg-slate-900/50 rounded p-2 border border-slate-700 relative">
                        ${i === dealerIdx ? '<div class="absolute -top-1.5 -right-1.5 text-indigo-400 text-[8px] bg-slate-900 rounded-full w-4 h-4 flex items-center justify-center border border-indigo-500"><i class="fas fa-hat-wizard"></i></div>' : ''}
                        <div class="text-[8px] text-slate-500 uppercase truncate mb-1">${p.name}</div>
                        <div class="text-xl font-logo text-amber-500">${state.currentBids[i] || 0}</div>
                    </div>
                `).join('');
                
            } else {
                state.phase = 'bidding';
                renderGame();
            }

            document.getElementById('roundHistory').innerHTML = [...state.rounds].reverse().map(r => `
                <div class="card-stone p-4 rounded-xl border-l-2 border-indigo-500">
                    <div class="flex justify-between items-center border-b border-white/5 pb-2 mb-3">
                        <span class="font-logo text-indigo-400 text-sm tracking-wider">Round ${r.roundNum}</span>
                        <span class="text-[9px] text-slate-500 font-bold uppercase bg-slate-950/50 px-2 py-1 rounded border border-white/5">${r.cards} Cards</span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        ${r.results.map(res => `
                            <div class="flex flex-col items-center bg-slate-950/30 rounded-lg p-2 border border-white/5">
                                <span class="text-[9px] font-bold text-slate-500 uppercase tracking-widest mb-1 truncate w-full text-center">${res.name}</span>
                                <span class="text-xl font-logo ${res.points >= 0 ? 'text-emerald-400 drop-shadow-[0_0_5px_rgba(52,211,153,0.5)]' : 'text-rose-500'} mb-1">
                                    ${res.points > 0 ? '+' : ''}${res.points}
                                </span>
                                <div class="flex items-center gap-2 text-[9px] bg-black/40 px-3 py-1 rounded-full border border-white/5 text-slate-400 font-bold font-mono">
                                    <span>${res.bid}</span>
                                    <span class="text-slate-700">/</span>
                                    <span class="${res.bid === res.actual ? 'text-emerald-400' : 'text-rose-400'}">${res.actual}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function handleActionClick() { openModal(state.phase); }

        // --- MODAL LOGIC ---
        function openModal(mode) {
            const modal = document.getElementById('gameModal');
            const content = document.getElementById('modalContent');
            const dealerIdx = (state.currentRound - 1) % state.players.length;
            
            modal.classList.remove('hidden-modal');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);

            document.getElementById('modalTitle').innerText = `Round: ${state.currentRound} / ${state.maxRounds}`;

            if (mode === 'bidding') {
                document.getElementById('modalSubtitle').innerText = `${state.currentRound} Cards`;
                content.innerHTML = state.players.map((p, i) => `
                    <div class="bg-slate-900/80 p-3 rounded-xl border ${i === dealerIdx ? 'border-indigo-500' : 'border-slate-800'} flex items-center justify-between transition-colors">
                        <div class="flex flex-col">
                            <span class="font-bold text-slate-200 text-sm flex items-center gap-2">
                                ${p.name}
                                ${i === dealerIdx ? '<span class="text-indigo-400 text-xs drop-shadow-[0_0_5px_rgba(99,102,241,0.8)]"><i class="fas fa-hat-wizard"></i></span>' : ''}
                            </span>
                            ${i === dealerIdx ? '<span class="text-[8px] text-indigo-400 font-bold uppercase tracking-widest">Dealer</span>' : ''}
                        </div>
                        <div class="flex items-center gap-3">
                            <label class="text-[9px] uppercase font-bold text-slate-600 tracking-wider">Bid</label>
                            <input type="number" id="input-${i}" pattern="[0-9]*" inputmode="numeric" min="0" oninput="validateInputs('bidding')" class="w-16 input-stone rounded-lg p-3 text-center font-logo text-xl outline-none transition-all">
                        </div>
                    </div>
                `).join('');
                setTimeout(() => document.getElementById('input-0').focus(), 100);

            } else {
                document.getElementById('modalSubtitle').innerText = `Verify the Truth`;
                content.innerHTML = state.players.map((p, i) => `
                    <div class="bg-slate-900/80 p-3 rounded-xl border border-slate-800 flex items-center justify-between">
                        <div class="flex flex-col">
                            <span class="font-bold text-slate-200 text-sm">${p.name}</span>
                            <span class="text-[9px] text-indigo-400 font-bold uppercase tracking-wider">Bid: ${state.currentBids[i]}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <label class="text-[9px] uppercase font-bold text-slate-600 tracking-wider">Got</label>
                            <input type="number" id="input-${i}" pattern="[0-9]*" inputmode="numeric" min="0" oninput="validateInputs('scoring')" class="w-16 input-stone rounded-lg p-3 text-center font-logo text-xl outline-none transition-all">
                        </div>
                    </div>
                `).join('');
                setTimeout(() => document.getElementById('input-0').focus(), 100);
            }
            
            validateInputs(mode);
        }

        function validateInputs(mode) {
            const btn = document.getElementById('modalSubmitBtn');
            const msg = document.getElementById('validationMsg');
            let total = 0;
            let allFilled = true;

            state.players.forEach((_, i) => {
                const el = document.getElementById(`input-${i}`);
                if (el.value < 0 && el.value !== "") el.value = 0;
                if (el.value === "") allFilled = false;
                total += parseInt(el.value || 0);
            });

            if (mode === 'bidding') {
                const isForbidden = (total === state.currentRound);
                if (allFilled && isForbidden) {
                    msg.classList.remove('hidden');
                    btn.disabled = true;
                } else {
                    msg.classList.add('hidden');
                    btn.disabled = !allFilled;
                }
            } else {
                const isMatch = (total === state.currentRound);
                if (allFilled && !isMatch) {
                    msg.innerHTML = `<i class="fas fa-balance-scale-right mr-1"></i> Reality is Broken!<br><span class="opacity-70 text-[9px] normal-case">(Tricks count: ${total} / ${state.currentRound})</span>`;
                    msg.classList.remove('hidden');
                    btn.disabled = true;
                } else {
                    msg.classList.add('hidden');
                    btn.disabled = !allFilled;
                }
            }
        }

        function submitModal() {
            if (state.phase === 'bidding') {
                state.players.forEach((_, i) => {
                    const val = parseInt(document.getElementById(`input-${i}`).value);
                    state.currentBids[i] = val;
                });
                state.phase = 'playing';
                save();
                closeModal();
                renderGame();
            } else {
                const roundData = { roundNum: state.currentRound, cards: state.currentRound, results: [] };
                
                state.players.forEach((p, i) => {
                    const bid = state.currentBids[i];
                    const actual = parseInt(document.getElementById(`input-${i}`).value);
                    let points = 0;
                    
                    if (bid === actual) {
                        points = 20 + (actual * 10);
                    } else {
                        points = -10 * Math.abs(bid - actual);
                    }
                    
                    p.score += points;
                    roundData.results.push({ name: p.name, bid, actual, points });
                });

                state.rounds.push(roundData);
                state.currentRound++;
                state.currentBids = {};
                state.phase = 'bidding';
                
                save();
                closeModal();
                renderGame();
                
                if (state.currentRound > state.maxRounds) {
                   setTimeout(() => {
                       alert("The Prophecy is Complete! Check the winner.");
                   }, 500);
                }
            }
        }

        function closeModal() {
            const modal = document.getElementById('gameModal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden-modal'), 200);
        }

        function resetGame() {
            if(confirm("Cast Obliviate? (Reset Game)")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        init();
    </script>
</body>
</html>
